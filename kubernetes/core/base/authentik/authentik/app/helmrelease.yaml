---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/refs/heads/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
spec:
  releaseName: authentik
  chartRef:
    kind: OCIRepository
    name: authentik
  interval: 50m
  install:
    createNamespace: true
    remediation:
      retries: 3
  valuesFrom:
    # Authentik Secret Key
    - kind: Secret
      name: authentik-secret-key
      valuesKey: secretKey
      targetPath: authentik.secret_key
    # SMTP configuration mirrored from the external-secrets secret store
    - kind: Secret
      name: smtp-config
      valuesKey: smtp_username
      targetPath: authentik.email.username
    - kind: Secret
      name: smtp-config
      valuesKey: smtp_token
      targetPath: authentik.email.password
    - kind: Secret
      name: smtp-config
      valuesKey: smtp_server
      targetPath: authentik.email.host
    - kind: Secret
      name: smtp-config
      valuesKey: smtp_port
      targetPath: authentik.email.port

  values:
    authentik:
      log_level: debug
      secret_key: # Replaced by fluxcd on installed with the content of authentik-secret-key
      error_reporting:
        enabled: false
      postgresql:
        host: postgres-db-rw.${psql_database_namespace}.svc.cluster.local
        name: ${PSQL_DB_NAME}
        user: ${PSQL_DB_USER}
        password: file:///postgres-creds/password
      redis:
        host: dragonfly-cluster.dragonfly.svc.cluster.local

      email:
        # host: replaced by valueFrom
        # port: replaced by valueFrom
        # username: replaced by valueFrom
        # password: replaced by valueFrom
        use_tls: true
    #   secret_key: replaced by valueFrom

    global:
      addPrometheusAnnotations: true
    
      deploymentStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 0
          maxSurge: 1
      env:
        - name: AUTHENTIK_STORAGE__MEDIA__S3__ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: accessKey
              name: ${S3_USER}-s3user
        - name: AUTHENTIK_STORAGE__MEDIA__S3__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: secretKey
              name: ${S3_USER}-s3user
        - name: AUTHENTIK_STORAGE__MEDIA__S3__BUCKET_NAME
          value: ${BUCKET_NAME}
        - name: AUTHENTIK_STORAGE__MEDIA__S3__ENDPOINT
          value: http://${minio_url}
        - name: AUTHENTIK_STORAGE__MEDIA__S3__CUSTOM_DOMAIN
          value: ${minio_url}/${BUCKET_NAME}
        - name: AUTHENTIK_REDIS__DB
          value: "15"
        - name: AUTHENTIK_BOOTSTRAP_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: authentik-akadmin
        - name: AUTHENTIK_STORAGE__MEDIA__BACKEND
          value: s3
        - name: AUTHENTIK_STORAGE__MEDIA__S3__SECURE_URLS
          value: "false" # "true" if prod

      volumeMounts:
        - name: sidecar-blueprints
          mountPath: /blueprints/sidecar
        - name: sidecar-certs
          mountPath: /certs/sidecar

      volumes:
        - name: sidecar-blueprints
          emptyDir: {}
        - name: sidecar-certs
          emptyDir: {}
    
    server:
      serviceAccountName: authentik
      replicas: 1
      pdb:
        enabled: true
        minAvailable: 1
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 512Mi
      ingress:
        ingressClassName: traefik
        enabled: false
      volumes:
        - name: postgres-creds
          secret:
            secretName: &authentik-db-secret ${APP}-db-creds
      volumeMounts:
        - name: postgres-creds
          mountPath: /postgres-creds
          readOnly: true
    
    worker:
      serviceAccountName: authentik
      replicas: 1
      pdb:
        enabled: true
        minAvailable: 1
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 512Mi
      volumes:
        - name: postgres-creds
          secret:
            secretName: *authentik-db-secret
      volumeMounts:
        - name: postgres-creds
          mountPath: /postgres-creds
          readOnly: true

      extraContainers:
      - name: sidecar-blueprints
        image: "ghcr.io/kiwigrid/k8s-sidecar:2.1.4"
        env:
          - name: "FOLDER"
            value: "/blueprints/sidecar"
          - name: "LABEL"
            value: "goauthentik_blueprint"
          - name: "LABEL_VALUE"
            value: "1"
          - name: "NAMESPACE"
            value: "ALL"
          - name: "RESOURCE"
            value: "both"
          - name: "UNIQUE_FILENAMES"
            value: "true"
        volumeMounts:
          - name: sidecar-blueprints
            mountPath: /blueprints/sidecar
      - name: sidecar-certs
        image: "ghcr.io/kiwigrid/k8s-sidecar:2.1.4"
        env:
          - name: "FOLDER"
            value: "/certs/sidecar"
          - name: "LABEL"
            value: "goauthentik_cert"
          - name: "LABEL_VALUE"
            value: "1"
          - name: "RESOURCE"
            value: "both"
          - name: "UNIQUE_FILENAMES"
            value: "true"
        volumeMounts:
          - name: sidecar-certs
            mountPath: /certs/sidecar
    
    serviceAccount:
      create: true      

    # Disable included postgres and redis
    postgres:
      enabled: false
    redis:
      enabled: false