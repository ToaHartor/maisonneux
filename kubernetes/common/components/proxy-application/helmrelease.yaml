---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/refs/heads/main/helmrelease-helm-v2.json
# Required variables : APP, GROUP, SUBDOMAIN, DESCRIPTION, auth_subdomain, main_domain_websecure
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ${APP}-proxy
  labels:
    homelab/auth-component: "true"
spec:
  releaseName: ${APP}-proxy
  chartRef:
    kind: OCIRepository
    name: authentik-application
  interval: 50m
  install:
    createNamespace: true
    remediation:
      retries: 3

  values:
    # From https://codeberg.org/wrenix/helm-charts/src/branch/main/authentik-application/values.yaml
    blueprint:
      authentik:
        domain: "https://${auth_subdomain}.${main_domain_websecure}"
      provider:
        enabled: true
        name: "${APP}"
        type: "proxy"
        proxy:
          externalHost: &ext-host "https://${SUBDOMAIN}.${main_domain_websecure}"
          skipPathRegex: ""
          cookieDomain: ""
          ingress:
            enabled: false

      application:
        name: "${APP}"
        slug: "${APP}"
        group: "${GROUP}"
        launchURL: *ext-host
        openInNewTab: false
        icon: ""
        description: "${DESCRIPTION}"
        bindPolicyID:
        policyEngineMode: "any"
      groups: []
        # Add groups via patch