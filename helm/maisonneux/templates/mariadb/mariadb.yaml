apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: mariadb
  namespace: mariadb
spec:
  replicas: 3
  replicasAllowEvenNumber: false
  # TODO : Correct password generation
  rootPasswordSecretKeyRef:
    name: mariadb-root
    key: password
    generate: true
  username: mariadb

  passwordSecretKeyRef:
    name: mariadb-password
    key: password
    generate: true
  database: mariadb

  port: 3306

  storage:
    size: 1Gi
    storageClassName: {{ .Values.storage.persistentClassName }}
    resizeInUseVolumes: true
    waitForVolumeResize: true
    volumeClaimTemplate:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: {{ .Values.storage.persistentClassName }}

  #   service:
  #     type: LoadBalancer
  #     metadata:
  #       annotations:
  #         metallb.universe.tf/loadBalancerIPs: 172.18.0.20

  podDisruptionBudget:
    maxUnavailable: 33%
  affinity:
    antiAffinityEnabled: true

  # tolerations:
  #   - key: "k8s.mariadb.com/ha"
  #     operator: "Exists"
  #     effect: "NoSchedule"

  replication:
    enabled: true
    primary:
      podIndex: 0
      automaticFailover: true
    replica:
      waitPoint: AfterSync
      gtid: CurrentPos
      replPasswordSecretKeyRef:
        name: mariadb
        key: password
      connectionTimeout: 10s
      connectionRetries: 10
      syncTimeout: 10s
    syncBinlog: true
    probesEnabled: true

  myCnf: |
    [mariadb]
    bind-address=*
    default_storage_engine=InnoDB
    binlog_format=row
    innodb_autoinc_lock_mode=2
    innodb_buffer_pool_size=1024M
    max_allowed_packet=256M

  # Probes
  livenessProbe:
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 5
  readinessProbe:
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 5
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      memory: 1Gi
  metrics:
    enabled: true
