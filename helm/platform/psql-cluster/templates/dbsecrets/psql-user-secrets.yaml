{{- $root := . -}}
{{- range $user := .Values.database.users -}}
{{- $secretName := include "common.db.secret-name" (dict "DatabaseUser" $user ) }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $secretName }}
  namespace: {{ $root.Release.Namespace }}
spec:
  # refreshPolicy: Periodic
  # refreshInterval: "1h"
  dataFrom:
  - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: ClusterGenerator
        name: "{{ $root.Values.secretGenerators.databasePassword }}"

  target:
    template:
      metadata:
        labels:
          cnpg.io/reload: "true"
      data:
        username: "{{ $user }}"
        password: "{{ `{{ .password }}` }}"
      engineVersion: v2
---
{{- end -}}