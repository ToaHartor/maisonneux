apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: zot
  namespace: internal-ci
spec:
  releaseName: zot
  dependsOn:
    - name: s3-operator # Required for persistency
      namespace: operators
  chart:
    spec:
      chart: helm/platform/zot
      interval: 30m
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      reconcileStrategy: Revision
  interval: 50m
  install:
    createNamespace: true
    remediation:
      retries: 3
  # Edit values in helm/platform/zot/values.yaml
  values:
    s3:
      bucketName: zot-${environment}
    zot:
      env:
        - name: "AWS_ACCESS_KEY_ID"
          valueFrom:
            secretKeyRef:
              name: &s3user zot-${environment}-s3user
              key: accessKey
        - name: "AWS_SECRET_ACCESS_KEY"
          valueFrom:
            secretKeyRef:
              name: *s3user
              key: secretKey

      configFiles:
        config.json: |-
          {
            "distSpecVersion": "1.1.0",
            "storage": {
              "rootDirectory": "/tmp/zot/s3",
              "dedupe": true,
              "remoteCache": false,
              "gc": true,
              "gcDelay": "2h",
              "gcInterval": "24h",
              "storageDriver": {
                "name": "s3",
                "region": "auto",
                "regionendpoint": "http://${minio_url}",
                "bucket": "zot-${environment}",
                "forcepathstyle": true,
                "secure": false,
                "skipverify": false
              }
            },
            "http": {
                "address": "0.0.0.0",
                "port": "5000",
                "compat": ["docker2s2"]
            },
            "extensions": {
              "ui": {
                "enable": true
              },
              "search": {
                "enable": true
              },
              "metrics": {
                "enable": true,
                "prometheus": {
                  "path": "/metrics"
                }
              },
              "scrub": {
                "interval": "24h"
              },
              "sync": {
                "enable": true,
                "downloadDir": "/tmp/zot/s3/mirror",
                "registries": [
                  {
                    "urls": [
                      "https://index.docker.io"
                    ],
                    "content": [
                      {
                        "destination": "/docker.io",
                        "prefix": "**"
                      }
                    ],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": [
                      "https://registry.gitlab.com"
                    ],
                    "content": [
                      {
                        "destination": "/registry.gitlab.com",
                        "prefix": "**"
                      }
                    ],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": [
                      "https://ghcr.io"
                    ],
                    "content": [
                      {
                        "destination": "/ghcr.io",
                        "prefix": "**"
                      }
                    ],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": [
                      "https://quay.io"
                    ],
                    "content": [
                      {
                        "destination": "/quay.io",
                        "prefix": "**"
                      }
                    ],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": [
                      "https://gcr.io"
                    ],
                    "content": [
                      {
                        "destination": "/gcr.io",
                        "prefix": "**"
                      }
                    ],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": [
                      "https://registry.k8s.io"
                    ],
                    "content": [
                      {
                        "destination": "/registry.k8s.io",
                        "prefix": "**"
                      }
                    ],
                    "onDemand": true,
                    "tlsVerify": true
                  }
                ]
              }
            },
            "log": { "level": "debug" }
          }