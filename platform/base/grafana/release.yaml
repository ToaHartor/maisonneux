apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana
  namespace: monitoring
spec:
  releaseName: grafana
  dependsOn:
    - name: victoria-metrics-operator
    - name: grafana-oidc
  chart:
    spec:
      chart: helm/platform/grafana
      interval: 12h
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      reconcileStrategy: Revision
  interval: 50m
  install:
    createNamespace: true
    remediation:
      retries: 3
  postRenderers:
    # Add backup label to main grafana secret to backup admin password
    - kustomize:
        patches:
          # Modify default observability configmap following these settings
          # https://tekton.dev/docs/pipelines/metrics/#configuring-metrics-using-config-observability-configmap
          - target:
              version: v1
              kind: Secrets
              name: grafana
            patch: |
              - op: add
                path: /metadata/labels/homelab~1backup-resource
                value: "true"

  values:
    # Under grafana: https://github.com/grafana/helm-charts/blob/main/charts/grafana/values.yaml
    grafana:
      route:
        main:
          hostnames:
            - monitoring.${main_domain}
      
      grafana.ini:
        server:
          domain: monitoring.${main_domain}
          root_url: https://monitoring.${main_domain_websecure}
        auth:
          signout_redirect_url: "https://auth.${main_domain_websecure}/application/o/grafana/end-session/"
        
        auth.generic_oauth:
          auth_url: "https://auth.${main_domain_websecure}/application/o/authorize/"
          token_url: "https://auth.${main_domain_websecure}/application/o/token/"
          api_url: "https://auth.${main_domain_websecure}/application/o/userinfo/"